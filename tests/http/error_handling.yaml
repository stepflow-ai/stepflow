schema: https://stepflow.org/schemas/v1/flow.json
name: "Python Component Error Handling Test"
description: "Test that Python component errors are properly surfaced via JSON-RPC"

schemas:
  type: object
  properties:
    input:
      type: object
      properties:
        mode:
          type: string
          description: "Error mode: error, runtime_error, or success"
        message:
          type: string
          description: "Error message to include"
          default: ""
      required: [mode]

steps:
  - id: error_step
    component: "/test/error_test"
    input:
      mode:
        $input: mode
      message:
        $input: message

output:
  result:
    $step: error_step
    path: result

test:
  config:
    plugins:
      builtin:
        type: builtin
      test_http:
        type: stepflow
        command: uv
        args: ["run", "--project", "../../sdks/python", "--extra", "http", "python", "test_python_server.py"]
        healthCheck:
          path: /health
          timeoutMs: 10000
          retryDelayMs: 500

    routes:
      "/builtin/{component}":
        - plugin: builtin
      "/test/{component}":
        - plugin: test_http

  cases:
    - name: "StepflowExecutionError is surfaced correctly"
      input:
        mode: "error"
        message: "test error message"
      output:
        outcome: failed
        error:
          code: 500
          message: 'step "error_step" failed'

    - name: "RuntimeError is wrapped and surfaced"
      input:
        mode: "runtime_error"
        message: "unexpected failure"
      output:
        outcome: failed
        error:
          code: 500
          message: 'step "error_step" failed'

    - name: "Success case works normally"
      input:
        mode: "success"
        message: ""
      output:
        outcome: success
        result:
          result: "success"
