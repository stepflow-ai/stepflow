schema: https://stepflow.org/schemas/v1/flow.json
name: "Python Component Error Handling Test"
description: "Test that Python component errors are properly surfaced via JSON-RPC"

input_schema:
  type: object
  properties:
    mode:
      type: string
      description: "Error mode: error, runtime_error, or success"
    message:
      type: string
      description: "Error message to include"
      default: ""
  required: [mode]

steps:
  - id: error_step
    component: "/test/error_test"
    input:
      mode: { $from: { workflow: input }, path: "mode" }
      message: { $from: { workflow: input }, path: "message" }

output:
  result: { $from: { step: error_step }, path: "result" }

test:
  servers:
    test_http:
      command: "uv"
      args: ["run", "--project", "../../sdks/python", "--extra", "http", "python", "test_python_server.py", "--http", "--port", "{port}"]
      env: {}
      working_directory: ""
      port_range: [18000, 19000]
      health_check:
        path: "/health"
        timeout_ms: 5000
        retry_attempts: 10
        retry_delay_ms: 500
      startup_timeout_ms: 10000
      shutdown_timeout_ms: 5000

  config:
    plugins:
      builtin:
        type: builtin
      test_http:
        type: stepflow
        transport: http
        url: "{test_http.url}"

    routes:
      "/builtin/{component}":
        - plugin: builtin
      "/test/{component}":
        - plugin: test_http

  cases:
    - name: "StepflowExecutionError is surfaced correctly"
      input:
        mode: "error"
        message: "test error message"
      output:
        outcome: failed
        error:
          code: 500
          message: 'step "error_step" failed'

    - name: "RuntimeError is wrapped and surfaced"
      input:
        mode: "runtime_error"
        message: "unexpected failure"
      output:
        outcome: failed
        error:
          code: 500
          message: 'step "error_step" failed'

    - name: "Success case works normally"
      input:
        mode: "success"
        message: ""
      output:
        outcome: success
        result:
          result: "success"
