{
  "openapi": "3.1.0",
  "info": {
    "title": "Stepflow API",
    "description": "API for Stepflow flows and runs",
    "contact": {
      "name": "Ben Chambers"
    },
    "license": {
      "name": "Apache-2.0",
      "identifier": "Apache-2.0"
    },
    "version": "0.9.0"
  },
  "paths": {
    "/blobs": {
      "post": {
        "tags": [
          "Blob"
        ],
        "summary": "Store a blob and return its content-based ID",
        "operationId": "store_blob",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/StoreBlobRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Blob stored successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/StoreBlobResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid request"
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/blobs/{blob_id}": {
      "get": {
        "tags": [
          "Blob"
        ],
        "summary": "Get a blob by its ID",
        "operationId": "get_blob",
        "parameters": [
          {
            "name": "blob_id",
            "in": "path",
            "description": "Blob ID to retrieve",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Blob retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/GetBlobResponse"
                }
              }
            }
          },
          "404": {
            "description": "Blob not found"
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/components": {
      "get": {
        "tags": [
          "Component"
        ],
        "summary": "List all available components from plugins",
        "operationId": "list_components",
        "parameters": [
          {
            "name": "includeSchemas",
            "in": "query",
            "description": "Whether to include schemas in the response (default: true)",
            "required": false,
            "schema": {
              "type": "boolean"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Components listed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ListComponentsResponse"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error"
          }
        }
      }
    },
    "/flows": {
      "post": {
        "tags": [
          "Flow"
        ],
        "summary": "Store a flow and return its hash",
        "operationId": "store_flow",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/StoreFlowRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Flow stored successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/StoreFlowResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid flow"
          }
        }
      }
    },
    "/flows/{flow_id}": {
      "get": {
        "tags": [
          "Flow"
        ],
        "summary": "Get a flow by its ID",
        "operationId": "get_flow",
        "parameters": [
          {
            "name": "flow_id",
            "in": "path",
            "description": "Flow ID to retrieve",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Flow retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/FlowResponse"
                }
              }
            }
          },
          "404": {
            "description": "Flow not found"
          }
        }
      },
      "delete": {
        "tags": [
          "Flow"
        ],
        "summary": "Delete a flow by ID",
        "operationId": "delete_flow",
        "parameters": [
          {
            "name": "flow_id",
            "in": "path",
            "description": "Flow ID to delete",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "204": {
            "description": "Flow deleted successfully"
          },
          "404": {
            "description": "Flow not found"
          },
          "409": {
            "description": "Flow has active runs"
          }
        }
      }
    },
    "/health": {
      "get": {
        "tags": [
          "health"
        ],
        "summary": "Check service health",
        "operationId": "health_check",
        "parameters": [
          {
            "name": "error",
            "in": "query",
            "description": "Trigger an error for testing error response format",
            "required": false,
            "schema": {
              "type": [
                "string",
                "null"
              ]
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Service is healthy",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HealthResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad request - triggered by ?error=bad_request"
          },
          "404": {
            "description": "Not found - triggered by ?error=not_found"
          },
          "500": {
            "description": "Internal server error - triggered by ?error=internal or ?error=stack"
          }
        }
      }
    },
    "/runs": {
      "get": {
        "tags": [
          "Run"
        ],
        "summary": "List executions with optional filtering",
        "operationId": "list_runs",
        "parameters": [
          {
            "name": "status",
            "in": "query",
            "description": "Filter by execution status",
            "required": false,
            "schema": {
              "oneOf": [
                {
                  "type": "null"
                },
                {
                  "$ref": "#/components/schemas/ExecutionStatus"
                }
              ]
            }
          },
          {
            "name": "flowName",
            "in": "query",
            "description": "Filter by flow name",
            "required": false,
            "schema": {
              "type": [
                "string",
                "null"
              ]
            }
          },
          {
            "name": "rootRunId",
            "in": "query",
            "description": "Filter to runs under this root (includes the root itself)",
            "required": false,
            "schema": {
              "type": [
                "string",
                "null"
              ],
              "format": "uuid"
            }
          },
          {
            "name": "parentRunId",
            "in": "query",
            "description": "Filter to direct children of this parent run",
            "required": false,
            "schema": {
              "type": [
                "string",
                "null"
              ],
              "format": "uuid"
            }
          },
          {
            "name": "rootsOnly",
            "in": "query",
            "description": "Filter to only root runs (runs where parent_run_id is None)",
            "required": false,
            "schema": {
              "type": [
                "boolean",
                "null"
              ]
            }
          },
          {
            "name": "maxDepth",
            "in": "query",
            "description": "Maximum depth for hierarchy queries (0 = root only)",
            "required": false,
            "schema": {
              "type": [
                "integer",
                "null"
              ],
              "format": "int32",
              "minimum": 0
            }
          },
          {
            "name": "limit",
            "in": "query",
            "description": "Maximum number of results to return",
            "required": false,
            "schema": {
              "type": [
                "integer",
                "null"
              ],
              "minimum": 0
            }
          },
          {
            "name": "offset",
            "in": "query",
            "description": "Number of results to skip",
            "required": false,
            "schema": {
              "type": [
                "integer",
                "null"
              ],
              "minimum": 0
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Runs listed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ListRunsResponse"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error"
          }
        }
      },
      "post": {
        "tags": [
          "Run"
        ],
        "summary": "Create and execute a flow by hash",
        "description": "Supports both single and batch execution:\n- Single input: Executes one run and returns the result directly\n- Multiple inputs: Executes batch and waits for all results",
        "operationId": "create_run",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateRunRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Flow run created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CreateRunResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid request"
          },
          "404": {
            "description": "Flow not found"
          },
          "500": {
            "description": "Internal server error"
          }
        }
      }
    },
    "/runs/{run_id}": {
      "get": {
        "tags": [
          "Run"
        ],
        "summary": "Get execution details by ID",
        "operationId": "get_run",
        "parameters": [
          {
            "name": "run_id",
            "in": "path",
            "description": "Run ID (UUID)",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Run details retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RunDetails"
                }
              }
            }
          },
          "400": {
            "description": "Invalid run ID format"
          },
          "404": {
            "description": "Run not found"
          },
          "500": {
            "description": "Internal server error"
          }
        }
      },
      "delete": {
        "tags": [
          "Run"
        ],
        "summary": "Delete a completed execution",
        "operationId": "delete_run",
        "parameters": [
          {
            "name": "run_id",
            "in": "path",
            "description": "Run ID (UUID)",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "responses": {
          "204": {
            "description": "Run deleted successfully"
          },
          "400": {
            "description": "Invalid run ID format"
          },
          "404": {
            "description": "Run not found"
          },
          "409": {
            "description": "Run still running"
          },
          "500": {
            "description": "Internal server error"
          }
        }
      }
    },
    "/runs/{run_id}/cancel": {
      "post": {
        "tags": [
          "Run"
        ],
        "summary": "Cancel a running execution",
        "operationId": "cancel_run",
        "parameters": [
          {
            "name": "run_id",
            "in": "path",
            "description": "Run ID (UUID)",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Run cancelled successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RunSummary"
                }
              }
            }
          },
          "400": {
            "description": "Invalid run ID format"
          },
          "404": {
            "description": "Run not found"
          },
          "409": {
            "description": "Run already completed"
          },
          "500": {
            "description": "Internal server error"
          }
        }
      }
    },
    "/runs/{run_id}/flow": {
      "get": {
        "tags": [
          "Run"
        ],
        "summary": "Get the workflow definition for an execution",
        "operationId": "get_run_flow",
        "parameters": [
          {
            "name": "run_id",
            "in": "path",
            "description": "Run ID (UUID)",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Run workflow retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RunFlowResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid run ID format"
          },
          "404": {
            "description": "Run or workflow not found"
          },
          "500": {
            "description": "Internal server error"
          }
        }
      }
    },
    "/runs/{run_id}/items": {
      "get": {
        "tags": [
          "Run"
        ],
        "summary": "Get all item results for a run",
        "description": "Returns results for all items in the run, ordered by item index.\nFor single-item runs (item_count=1), returns a single item.",
        "operationId": "get_run_items",
        "parameters": [
          {
            "name": "run_id",
            "in": "path",
            "description": "Run ID (UUID)",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Run items retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ListItemsResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid run ID format"
          },
          "404": {
            "description": "Run not found"
          },
          "500": {
            "description": "Internal server error"
          }
        }
      }
    },
    "/runs/{run_id}/steps": {
      "get": {
        "tags": [
          "Run"
        ],
        "summary": "Get step-level execution details for a specific execution",
        "operationId": "get_run_steps",
        "parameters": [
          {
            "name": "run_id",
            "in": "path",
            "description": "Run ID (UUID)",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "item_index",
            "in": "query",
            "description": "Item index for multi-item runs. If not specified, aggregates across all items.",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 0
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Run step details retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ListStepRunsResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid run ID format or item index out of bounds"
          },
          "404": {
            "description": "Run not found"
          },
          "500": {
            "description": "Internal server error"
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "BlobId": {
        "type": "string",
        "description": "A SHA-256 hash of the blob content, represented as a hexadecimal string."
      },
      "BlobType": {
        "type": "string",
        "description": "Type of blob stored in the blob store.",
        "enum": [
          "flow",
          "data"
        ]
      },
      "Component": {
        "type": "string",
        "description": "Identifies a specific plugin and atomic functionality to execute. Use component name for builtins (e.g., 'eval') or path format for plugins (e.g., '/python/udf').",
        "examples": [
          "/builtin/eval",
          "/mcpfs/list_files",
          "/python/udf"
        ]
      },
      "ComponentInfo": {
        "type": "object",
        "required": [
          "component"
        ],
        "properties": {
          "component": {
            "$ref": "#/components/schemas/Component",
            "description": "The component ID."
          },
          "description": {
            "type": [
              "string",
              "null"
            ],
            "description": "Optional description of the component."
          },
          "input_schema": {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "$ref": "#/components/schemas/Schema",
                "description": "The input schema for the component.\n\nCan be any valid JSON schema (object, primitive, array, etc.)."
              }
            ]
          },
          "output_schema": {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "$ref": "#/components/schemas/Schema",
                "description": "The output schema for the component.\n\nCan be any valid JSON schema (object, primitive, array, etc.)."
              }
            ]
          }
        }
      },
      "CreateRunRequest": {
        "type": "object",
        "description": "Request to create/execute a flow.\n\nThe `input` field is always an array of input values:\n- Single-item array `[value]`: Executes one run with `value` as input\n- Multi-item array `[v1, v2, ...]`: Executes multiple runs (batch mode)\n\nThis design avoids ambiguity: to run a workflow with an array as input,\nwrap it in another array: `[[1, 2, 3]]` runs once with input `[1, 2, 3]`.",
        "required": [
          "flowId",
          "input"
        ],
        "properties": {
          "flowId": {
            "$ref": "#/components/schemas/BlobId",
            "description": "The flow hash to execute"
          },
          "input": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/Value"
            },
            "description": "Input data for the flow - always an array (one element per run)"
          },
          "overrides": {
            "$ref": "#/components/schemas/WorkflowOverrides",
            "description": "Optional workflow overrides to apply before execution"
          },
          "variables": {
            "type": "object",
            "description": "Optional variables to provide for variable references in the workflow",
            "additionalProperties": {
              "$ref": "#/components/schemas/Value"
            },
            "propertyNames": {
              "type": "string"
            }
          },
          "maxConcurrency": {
            "type": [
              "integer",
              "null"
            ],
            "description": "Maximum concurrency for batch execution (only used when input is an array)",
            "minimum": 0
          }
        }
      },
      "CreateRunResponse": {
        "type": "object",
        "description": "Response for create run operations",
        "required": [
          "runId",
          "itemCount",
          "status"
        ],
        "properties": {
          "runId": {
            "type": "string",
            "format": "uuid",
            "description": "The run ID (for single runs) or batch ID (for batch runs)"
          },
          "itemCount": {
            "type": "integer",
            "format": "int32",
            "description": "Number of items in this run (1 for single runs, > 1 for batch runs)",
            "minimum": 0
          },
          "result": {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "$ref": "#/components/schemas/FlowResult",
                "description": "The result of the flow execution (if completed, for single runs only)"
              }
            ]
          },
          "status": {
            "$ref": "#/components/schemas/ExecutionStatus",
            "description": "The run status"
          }
        }
      },
      "Diagnostic": {
        "type": "object",
        "description": "A diagnostic with error code, message, path, and metadata.\n\nCreated via the `diagnostic!` macro with optional builder methods:\n\n```ignore\ndiagnostic!(DiagnosticKind::DuplicateStepId, \"Duplicate step ID '{step_id}'\", { step_id })\n    .at(path)\n    .experimental()\n```\n\n## JSON Format\n\n```json\n{\n  \"kind\": \"duplicateStepId\",\n  \"code\": 3000,\n  \"level\": \"fatal\",\n  \"formatted\": \"Duplicate step ID 'foo'\",\n  \"data\": { \"stepId\": \"foo\" },\n  \"path\": \"$.steps[0]\",\n  \"experimental\": false\n}\n```",
        "required": [
          "kind",
          "code",
          "level",
          "formatted"
        ],
        "properties": {
          "kind": {
            "type": "string",
            "description": "The diagnostic kind name (camelCase)"
          },
          "code": {
            "type": "integer",
            "format": "int32",
            "description": "Numeric error code",
            "minimum": 0
          },
          "level": {
            "$ref": "#/components/schemas/DiagnosticLevel",
            "description": "The severity level"
          },
          "formatted": {
            "type": "string",
            "description": "Human-readable formatted message"
          },
          "data": {
            "description": "Structured data with camelCase keys (null if no data)"
          },
          "path": {
            "$ref": "#/components/schemas/Path",
            "description": "JSON path to the field with the issue"
          },
          "experimental": {
            "type": "boolean",
            "description": "Whether this diagnostic is experimental (may have false positives)"
          }
        }
      },
      "DiagnosticLevel": {
        "type": "string",
        "description": "Diagnostic level indicating severity and impact",
        "enum": [
          "fatal",
          "error",
          "warning"
        ]
      },
      "Diagnostics": {
        "type": "object",
        "description": "Collection of diagnostics with utility methods",
        "required": [
          "diagnostics",
          "numFatal",
          "numError",
          "numWarning"
        ],
        "properties": {
          "diagnostics": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/Diagnostic"
            },
            "description": "All diagnostics found"
          },
          "numFatal": {
            "type": "integer",
            "format": "int32",
            "minimum": 0
          },
          "numError": {
            "type": "integer",
            "format": "int32",
            "minimum": 0
          },
          "numWarning": {
            "type": "integer",
            "format": "int32",
            "minimum": 0
          }
        }
      },
      "ErrorAction": {
        "oneOf": [
          {
            "$ref": "#/components/schemas/OnErrorFail"
          },
          {
            "$ref": "#/components/schemas/OnErrorDefault"
          },
          {
            "$ref": "#/components/schemas/OnErrorRetry"
          }
        ],
        "description": "Error action determines what happens when a step fails.",
        "discriminator": {
          "propertyName": "action",
          "mapping": {
            "fail": "#/components/schemas/OnErrorFail",
            "retry": "#/components/schemas/OnErrorRetry",
            "useDefault": "#/components/schemas/OnErrorDefault"
          }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "description": "Error response structure.\n\nServer handlers should return this, but usually it is better to create it\nby returning an `error_stack::Report<ServerError>` and using the automatic\nconversion to `ErrorResponse`.\n\nOther `error_stack::Report` types will automatically convert to internal errors.",
        "required": [
          "code",
          "message"
        ],
        "properties": {
          "code": {
            "type": "integer",
            "format": "int32",
            "description": "HTTP status code (e.g., 400, 404, 500)",
            "minimum": 0
          },
          "message": {
            "type": "string",
            "description": "Human-readable error message"
          },
          "stack": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ErrorStackEntry"
            },
            "description": "Detailed error stack for debugging"
          }
        }
      },
      "ErrorStackEntry": {
        "type": "object",
        "description": "A single entry in an error stack for detailed error reporting",
        "required": [
          "error"
        ],
        "properties": {
          "error": {
            "type": "string",
            "description": "The error message"
          },
          "attachments": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Additional context attached to this error"
          },
          "backtrace": {
            "type": [
              "string",
              "null"
            ],
            "description": "Backtrace if available"
          }
        }
      },
      "ExampleInput": {
        "type": "object",
        "description": "An example input for a workflow that can be used in UI dropdowns.",
        "required": [
          "name",
          "input"
        ],
        "properties": {
          "name": {
            "type": "string",
            "description": "Name of the example input for display purposes."
          },
          "description": {
            "type": [
              "string",
              "null"
            ],
            "description": "Optional description of what this example demonstrates."
          },
          "input": {
            "$ref": "#/components/schemas/Value",
            "description": "The input data for this example."
          }
        }
      },
      "ExecutionStatus": {
        "type": "string",
        "description": "Status of a workflow execution",
        "enum": [
          "running",
          "completed",
          "failed",
          "cancelled",
          "paused",
          "recoveryFailed"
        ]
      },
      "Flow": {
        "type": "object",
        "description": "A workflow consisting of a sequence of steps and their outputs.\n\nA flow represents a complete workflow that can be executed. It contains:\n- A sequence of steps to execute\n- Named outputs that can reference step outputs\n\nFlows should not be cloned. They should generally be stored and passed as a\nreference or inside an `Arc`.",
        "properties": {
          "name": {
            "type": [
              "string",
              "null"
            ],
            "description": "The name of the flow."
          },
          "description": {
            "type": [
              "string",
              "null"
            ],
            "description": "The description of the flow."
          },
          "version": {
            "type": [
              "string",
              "null"
            ],
            "description": "The version of the flow."
          },
          "schemas": {
            "$ref": "#/components/schemas/FlowSchema",
            "description": "Consolidated schema information for the flow.\nContains input/output schemas, step output schemas, and shared `$defs`."
          },
          "steps": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/Step"
            },
            "description": "The steps to execute for the flow."
          },
          "output": {
            "$ref": "#/components/schemas/ValueExpr",
            "description": "The outputs of the flow, mapping output names to their values."
          },
          "test": {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "$ref": "#/components/schemas/TestConfig",
                "description": "Test configuration for the flow."
              }
            ]
          },
          "examples": {
            "type": [
              "array",
              "null"
            ],
            "items": {
              "$ref": "#/components/schemas/ExampleInput"
            },
            "description": "Example inputs for the workflow that can be used for testing and UI dropdowns."
          },
          "metadata": {
            "type": "object",
            "description": "Extensible metadata for the flow that can be used by tools and frameworks.",
            "additionalProperties": {},
            "propertyNames": {
              "type": "string"
            }
          }
        }
      },
      "FlowError": {
        "type": "object",
        "description": "An error reported from within a flow or step.",
        "required": [
          "code",
          "message"
        ],
        "properties": {
          "code": {
            "type": "integer",
            "format": "int64"
          },
          "message": {
            "type": "string"
          },
          "data": {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "$ref": "#/components/schemas/Value"
              }
            ]
          }
        }
      },
      "FlowResponse": {
        "type": "object",
        "description": "Response containing a flow definition and its ID",
        "required": [
          "flow",
          "flowId"
        ],
        "properties": {
          "flow": {
            "$ref": "#/components/schemas/Flow",
            "description": "The flow definition"
          },
          "flowId": {
            "$ref": "#/components/schemas/BlobId",
            "description": "The flow ID"
          },
          "allExamples": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ExampleInput"
            },
            "description": "All available examples (includes both examples and test cases)"
          }
        }
      },
      "FlowResult": {
        "oneOf": [
          {
            "$ref": "#/components/schemas/FlowResultSuccess"
          },
          {
            "$ref": "#/components/schemas/FlowResultFailed"
          }
        ],
        "title": "FlowResult",
        "description": "The results of a step execution.",
        "discriminator": {
          "propertyName": "outcome",
          "mapping": {
            "failed": "#/components/schemas/FlowResultFailed",
            "success": "#/components/schemas/FlowResultSuccess"
          }
        }
      },
      "FlowResultFailed": {
        "type": "object",
        "title": "FlowResultFailed",
        "description": "The step failed with the given error.",
        "required": [
          "outcome",
          "error"
        ],
        "properties": {
          "outcome": {
            "type": "string",
            "title": "FlowOutcome",
            "default": "failed",
            "enum": [
              "failed"
            ]
          },
          "error": {
            "$ref": "#/components/schemas/FlowError"
          }
        }
      },
      "FlowResultSuccess": {
        "type": "object",
        "title": "FlowResultSuccess",
        "description": "The step execution was successful.",
        "required": [
          "outcome",
          "result"
        ],
        "properties": {
          "outcome": {
            "type": "string",
            "title": "FlowOutcome",
            "default": "success",
            "enum": [
              "success"
            ]
          },
          "result": {
            "$ref": "#/components/schemas/Value"
          }
        }
      },
      "FlowSchema": {
        "type": "object",
        "description": "Consolidated schema information for a flow.\n\nThis struct contains all schema/type information for the flow in a single location,\nallowing shared `$defs` across all schemas and avoiding duplication.\n\nSerializes as a valid JSON Schema with `type: \"object\"` and flow-specific\nproperties (`input`, `output`, `variables`, `steps`) under the `properties` key.",
        "required": [
          "defs",
          "steps"
        ],
        "properties": {
          "defs": {
            "type": "object",
            "description": "Shared type definitions that can be referenced by other schemas.\nReferences use the format `#/schemas/$defs/TypeName`.",
            "additionalProperties": {
              "$ref": "#/components/schemas/Schema"
            },
            "propertyNames": {
              "type": "string"
            }
          },
          "input": {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "$ref": "#/components/schemas/Schema",
                "description": "The input schema for the flow."
              }
            ],
            "default": null
          },
          "output": {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "$ref": "#/components/schemas/Schema",
                "description": "The output schema for the flow."
              }
            ],
            "default": null
          },
          "variables": {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "$ref": "#/components/schemas/Schema",
                "description": "Schema for workflow variables. This is a JSON Schema object where\nproperties define the available variables and their types."
              }
            ],
            "default": null
          },
          "steps": {
            "type": "object",
            "description": "Output schemas for each step, keyed by step ID.\nNote: Step input schemas are not included here as they are\ncomponent metadata, not flow-specific schemas.\nUses IndexMap to preserve insertion order for deterministic serialization.",
            "additionalProperties": {
              "$ref": "#/components/schemas/Schema"
            },
            "propertyNames": {
              "type": "string"
            }
          }
        }
      },
      "GetBlobResponse": {
        "type": "object",
        "description": "Response when retrieving a blob",
        "required": [
          "data",
          "blobType",
          "blobId"
        ],
        "properties": {
          "data": {
            "$ref": "#/components/schemas/Value",
            "description": "The blob data"
          },
          "blobType": {
            "$ref": "#/components/schemas/BlobType",
            "description": "The blob type"
          },
          "blobId": {
            "$ref": "#/components/schemas/BlobId",
            "description": "The blob ID (for confirmation)"
          }
        }
      },
      "HealthQuery": {
        "type": "object",
        "description": "Health check query parameters",
        "properties": {
          "error": {
            "type": [
              "string",
              "null"
            ],
            "description": "Trigger an error for testing error response format"
          }
        }
      },
      "HealthResponse": {
        "type": "object",
        "description": "Health check response",
        "required": [
          "status",
          "timestamp",
          "version"
        ],
        "properties": {
          "status": {
            "type": "string",
            "description": "Service status"
          },
          "timestamp": {
            "type": "string",
            "description": "Timestamp when health was checked (RFC3339 format)"
          },
          "version": {
            "type": "string",
            "description": "Service version"
          }
        }
      },
      "ItemDetails": {
        "type": "object",
        "description": "Detailed information for a single item in a run.\n\nIncludes the item's input, execution status, and step-level details.",
        "required": [
          "itemIndex",
          "input",
          "status",
          "steps"
        ],
        "properties": {
          "itemIndex": {
            "type": "integer",
            "format": "int32",
            "description": "Index of this item in the input array (0-based).",
            "minimum": 0
          },
          "input": {
            "$ref": "#/components/schemas/Value",
            "description": "Input value for this item."
          },
          "status": {
            "$ref": "#/components/schemas/ExecutionStatus",
            "description": "Execution status of this item."
          },
          "steps": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/StepStatusInfo"
            },
            "description": "Step statuses for this item."
          },
          "completedAt": {
            "type": [
              "string",
              "null"
            ],
            "format": "date-time",
            "description": "When this item completed (if completed)."
          }
        }
      },
      "ItemResult": {
        "type": "object",
        "description": "Result for an individual item in a multi-item run.",
        "required": [
          "itemIndex",
          "status"
        ],
        "properties": {
          "itemIndex": {
            "type": "integer",
            "description": "Index of this item in the input array (0-based).",
            "minimum": 0
          },
          "status": {
            "$ref": "#/components/schemas/ExecutionStatus",
            "description": "Execution status of this item."
          },
          "result": {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "$ref": "#/components/schemas/FlowResult",
                "description": "Result of this item, if completed."
              }
            ]
          },
          "completedAt": {
            "type": [
              "string",
              "null"
            ],
            "format": "date-time",
            "description": "When this item completed (if completed)."
          }
        }
      },
      "ItemStatistics": {
        "type": "object",
        "description": "Statistics about items in a run.",
        "required": [
          "total",
          "completed",
          "running",
          "failed",
          "cancelled"
        ],
        "properties": {
          "total": {
            "type": "integer",
            "description": "Total number of items in this run.",
            "minimum": 0
          },
          "completed": {
            "type": "integer",
            "description": "Number of completed items.",
            "minimum": 0
          },
          "running": {
            "type": "integer",
            "description": "Number of currently running items.",
            "minimum": 0
          },
          "failed": {
            "type": "integer",
            "description": "Number of failed items.",
            "minimum": 0
          },
          "cancelled": {
            "type": "integer",
            "description": "Number of cancelled items.",
            "minimum": 0
          }
        }
      },
      "ListComponentsQuery": {
        "type": "object",
        "description": "Query parameters for listing components",
        "properties": {
          "includeSchemas": {
            "type": "boolean",
            "description": "Whether to include schemas in the response (default: true)"
          }
        }
      },
      "ListComponentsResponse": {
        "type": "object",
        "description": "Response for listing components",
        "required": [
          "components"
        ],
        "properties": {
          "components": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ComponentInfo"
            },
            "description": "List of available components"
          }
        }
      },
      "ListItemsResponse": {
        "type": "object",
        "description": "Response for listing run items",
        "required": [
          "itemCount",
          "items"
        ],
        "properties": {
          "itemCount": {
            "type": "integer",
            "description": "Total number of items in this run",
            "minimum": 0
          },
          "items": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ItemResult"
            },
            "description": "Individual item results ordered by item index"
          }
        }
      },
      "ListRunsQuery": {
        "type": "object",
        "description": "Query parameters for listing runs",
        "properties": {
          "status": {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "$ref": "#/components/schemas/ExecutionStatus",
                "description": "Filter by execution status"
              }
            ]
          },
          "flowName": {
            "type": [
              "string",
              "null"
            ],
            "description": "Filter by flow name"
          },
          "rootRunId": {
            "type": [
              "string",
              "null"
            ],
            "format": "uuid",
            "description": "Filter to runs under this root (includes the root itself)"
          },
          "parentRunId": {
            "type": [
              "string",
              "null"
            ],
            "format": "uuid",
            "description": "Filter to direct children of this parent run"
          },
          "rootsOnly": {
            "type": [
              "boolean",
              "null"
            ],
            "description": "Filter to only root runs (runs where parent_run_id is None)"
          },
          "maxDepth": {
            "type": [
              "integer",
              "null"
            ],
            "format": "int32",
            "description": "Maximum depth for hierarchy queries (0 = root only)",
            "minimum": 0
          },
          "limit": {
            "type": [
              "integer",
              "null"
            ],
            "description": "Maximum number of results to return",
            "minimum": 0
          },
          "offset": {
            "type": [
              "integer",
              "null"
            ],
            "description": "Number of results to skip",
            "minimum": 0
          }
        }
      },
      "ListRunsResponse": {
        "type": "object",
        "description": "Response for listing runs",
        "required": [
          "runs"
        ],
        "properties": {
          "runs": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/RunSummary"
            },
            "description": "List of run summaries"
          }
        }
      },
      "ListStepRunsResponse": {
        "type": "object",
        "description": "Response for listing step runs",
        "required": [
          "steps"
        ],
        "properties": {
          "steps": {
            "type": "object",
            "description": "Dictionary of step run results keyed by step ID",
            "additionalProperties": {
              "$ref": "#/components/schemas/StepRunResponse"
            },
            "propertyNames": {
              "type": "string"
            }
          }
        }
      },
      "OnErrorDefault": {
        "type": "object",
        "title": "OnErrorDefault",
        "description": "If the step fails, use the `defaultValue` instead.\nIf `defaultValue` is not specified, the step returns null.\nThe default value must be a literal JSON value (not an expression).\nFor dynamic defaults, use `$coalesce` in the consuming expression instead.",
        "required": [
          "action"
        ],
        "properties": {
          "action": {
            "type": "string"
          },
          "defaultValue": {
            "allOf": []
          }
        }
      },
      "OnErrorFail": {
        "type": "object",
        "title": "OnErrorFail",
        "description": "If the step fails, the flow will fail.",
        "required": [
          "action"
        ],
        "properties": {
          "action": {
            "type": "string"
          }
        }
      },
      "OnErrorRetry": {
        "type": "object",
        "title": "OnErrorRetry",
        "description": "If the step fails, retry it.",
        "required": [
          "action"
        ],
        "properties": {
          "action": {
            "type": "string"
          }
        }
      },
      "OverrideType": {
        "type": "string",
        "description": "The type of override operation to perform.",
        "enum": [
          "merge_patch",
          "json_patch"
        ]
      },
      "Path": {
        "type": "string",
        "description": "Path to a location in the workflow definition, serialized as a string",
        "examples": [
          "$.steps[0].input",
          "$.output",
          "$.steps[2].component"
        ]
      },
      "RunDetails": {
        "allOf": [
          {
            "$ref": "#/components/schemas/RunSummary"
          },
          {
            "type": "object",
            "properties": {
              "itemDetails": {
                "type": [
                  "array",
                  "null"
                ],
                "items": {
                  "$ref": "#/components/schemas/ItemDetails"
                },
                "description": "Item details with inputs and step statuses.\n- `None`: details not requested, or run is active (query executor)\n- `Some`: item-level details available"
              },
              "overrides": {
                "oneOf": [
                  {
                    "type": "null"
                  },
                  {
                    "$ref": "#/components/schemas/WorkflowOverrides",
                    "description": "Optional workflow overrides applied to this run (per-run, not per-item)."
                  }
                ]
              }
            }
          }
        ],
        "description": "Detailed flow run information including item details.\n\nFor completed runs, `item_details` contains per-item information including\ninputs and step statuses. For active runs, `item_details` may be `None`\n(query the owning orchestrator for live status)."
      },
      "RunFlowResponse": {
        "type": "object",
        "description": "Response containing a flow definition and its hash for run endpoints",
        "required": [
          "flow",
          "flowId"
        ],
        "properties": {
          "flow": {
            "$ref": "#/components/schemas/Flow",
            "description": "The flow definition"
          },
          "flowId": {
            "$ref": "#/components/schemas/BlobId",
            "description": "The flow hash"
          }
        }
      },
      "RunSummary": {
        "type": "object",
        "description": "Summary information about a flow run.",
        "required": [
          "runId",
          "flowId",
          "status",
          "createdAt",
          "rootRunId"
        ],
        "properties": {
          "runId": {
            "type": "string",
            "format": "uuid"
          },
          "flowId": {
            "$ref": "#/components/schemas/BlobId"
          },
          "flowName": {
            "type": [
              "string",
              "null"
            ]
          },
          "status": {
            "$ref": "#/components/schemas/ExecutionStatus"
          },
          "items": {
            "$ref": "#/components/schemas/ItemStatistics",
            "description": "Statistics about items in this run."
          },
          "createdAt": {
            "type": "string",
            "format": "date-time"
          },
          "completedAt": {
            "type": [
              "string",
              "null"
            ],
            "format": "date-time"
          },
          "rootRunId": {
            "type": "string",
            "format": "uuid",
            "description": "Root run ID for this execution tree.\n\nFor top-level runs, this equals `run_id`.\nFor sub-flows, this is the original run that started the tree."
          },
          "parentRunId": {
            "type": [
              "string",
              "null"
            ],
            "format": "uuid",
            "description": "Parent run ID if this is a sub-flow.\n\nNone for top-level runs, Some(parent_id) for sub-flows."
          },
          "orchestratorId": {
            "type": [
              "string",
              "null"
            ],
            "description": "The orchestrator currently managing this run.\n\nNone means the run is orphaned (no orchestrator owns it).\nSet when the run is created and updated during recovery."
          }
        }
      },
      "Schema": {
        "type": "object",
        "description": "A valid JSON Schema object."
      },
      "Step": {
        "type": "object",
        "description": "A step in a workflow that executes a component with specific arguments.\n\nNote: Step output schemas are stored in the flow's `types.steps` field,\nnot on individual steps. This allows for shared `$defs` and avoids duplication.",
        "required": [
          "id",
          "component"
        ],
        "properties": {
          "id": {
            "type": "string",
            "description": "Identifier for the step"
          },
          "component": {
            "$ref": "#/components/schemas/Component",
            "description": "The component to execute in this step"
          },
          "onError": {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "$ref": "#/components/schemas/ErrorAction"
              }
            ]
          },
          "input": {
            "$ref": "#/components/schemas/ValueExpr",
            "description": "Arguments to pass to the component for this step"
          },
          "mustExecute": {
            "type": [
              "boolean",
              "null"
            ],
            "description": "If true, this step must execute even if its output is not used by the workflow output.\nUseful for steps with side effects (e.g., writing to databases, sending notifications)."
          },
          "metadata": {
            "type": "object",
            "description": "Extensible metadata for the step that can be used by tools and frameworks.",
            "additionalProperties": {},
            "propertyNames": {
              "type": "string"
            }
          }
        }
      },
      "StepOverride": {
        "type": "object",
        "description": "Override specification for a single step.\n\nContains the override type (merge patch, json patch, etc.) and the value\nto apply. The type field uses `$type` to avoid collisions with step properties.",
        "required": [
          "value"
        ],
        "properties": {
          "$type": {
            "$ref": "#/components/schemas/OverrideType",
            "description": "The type of override to apply. Defaults to \"merge_patch\" if not specified."
          },
          "value": {
            "description": "The override value to apply, interpreted based on the override type."
          }
        }
      },
      "StepRunResponse": {
        "type": "object",
        "description": "Response for step run details",
        "required": [
          "stepId",
          "status"
        ],
        "properties": {
          "stepId": {
            "type": "string",
            "description": "Step ID (the stable identifier for this step in the workflow)"
          },
          "component": {
            "type": [
              "string",
              "null"
            ],
            "description": "Component name/URL that this step executes"
          },
          "status": {
            "$ref": "#/components/schemas/StepStatus",
            "description": "Current status of the step"
          },
          "result": {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "$ref": "#/components/schemas/FlowResult",
                "description": "The result of the step execution (if completed)"
              }
            ]
          }
        }
      },
      "StepStatus": {
        "type": "string",
        "description": "Status of an individual step within a workflow",
        "enum": [
          "blocked",
          "runnable",
          "running",
          "completed",
          "skipped",
          "failed"
        ]
      },
      "StepStatusInfo": {
        "type": "object",
        "description": "Status information for a single step execution.",
        "required": [
          "stepId",
          "status"
        ],
        "properties": {
          "stepId": {
            "type": "string",
            "description": "Step name/identifier."
          },
          "status": {
            "$ref": "#/components/schemas/StepStatus",
            "description": "Current status of the step."
          }
        }
      },
      "StoreBlobRequest": {
        "type": "object",
        "description": "Request to store a blob",
        "required": [
          "data"
        ],
        "properties": {
          "data": {
            "$ref": "#/components/schemas/Value",
            "description": "The JSON data to store"
          },
          "blobType": {
            "$ref": "#/components/schemas/BlobType",
            "description": "The type of blob (data or flow). Defaults to \"data\"."
          }
        }
      },
      "StoreBlobResponse": {
        "type": "object",
        "description": "Response when a blob is stored",
        "required": [
          "blobId"
        ],
        "properties": {
          "blobId": {
            "$ref": "#/components/schemas/BlobId",
            "description": "The content-based blob ID (SHA-256 hash)"
          }
        }
      },
      "StoreFlowRequest": {
        "type": "object",
        "description": "Request to store a flow",
        "required": [
          "flow"
        ],
        "properties": {
          "flow": {
            "$ref": "#/components/schemas/Flow",
            "description": "The flow to store"
          },
          "dryRun": {
            "type": "boolean",
            "description": "If true, only validate the flow without storing it"
          }
        }
      },
      "StoreFlowResponse": {
        "type": "object",
        "description": "Response when a flow is stored",
        "required": [
          "flowId",
          "stored",
          "diagnostics"
        ],
        "properties": {
          "flowId": {
            "$ref": "#/components/schemas/BlobId",
            "description": "The ID of the flow (computed from content hash, always present)"
          },
          "stored": {
            "type": "boolean",
            "description": "Whether the flow was actually stored (false for dry_run or if validation has fatal errors)"
          },
          "diagnostics": {
            "$ref": "#/components/schemas/Diagnostics",
            "description": "Validation diagnostics"
          }
        }
      },
      "TestCase": {
        "type": "object",
        "description": "A single test case for a workflow.",
        "required": [
          "name",
          "input"
        ],
        "properties": {
          "name": {
            "type": "string",
            "description": "Unique identifier for the test case."
          },
          "description": {
            "type": [
              "string",
              "null"
            ],
            "description": "Optional description of what this test case verifies."
          },
          "input": {
            "$ref": "#/components/schemas/Value",
            "description": "Input data for the workflow in this test case."
          },
          "output": {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "$ref": "#/components/schemas/FlowResult",
                "description": "Expected output from the workflow for this test case."
              }
            ]
          }
        }
      },
      "TestConfig": {
        "type": "object",
        "description": "Configuration for testing a workflow.",
        "properties": {
          "configFile": {
            "type": [
              "string",
              "null"
            ],
            "description": "Path to an external stepflow config file for tests.\nRelative paths are resolved from the workflow file's directory.\nMutually exclusive with `config` - validated at runtime."
          },
          "config": {
            "description": "Inline stepflow configuration for tests.\nMutually exclusive with `config_file` - validated at runtime."
          },
          "cases": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/TestCase"
            },
            "description": "Test cases for the workflow."
          }
        }
      },
      "Value": {
        "allOf": [],
        "description": "Any JSON value (object, array, string, number, boolean, or null)"
      },
      "ValueExpr": {
        "oneOf": [
          {
            "type": "object",
            "title": "StepRef",
            "description": "Step reference: { $step: \"step_id\", path?: \"...\" }",
            "required": [
              "$step"
            ],
            "properties": {
              "$step": {
                "type": "string"
              },
              "path": {
                "type": "string",
                "description": "JSONPath expression"
              }
            },
            "additionalProperties": false
          },
          {
            "type": "object",
            "title": "InputRef",
            "description": "Workflow input reference: { $input: \"path\" }",
            "required": [
              "$input"
            ],
            "properties": {
              "$input": {
                "type": "string",
                "description": "JSONPath expression"
              }
            },
            "additionalProperties": false
          },
          {
            "type": "object",
            "title": "VariableRef",
            "description": "Variable reference: { $variable: \"path\", default?: ValueExpr }",
            "required": [
              "$variable"
            ],
            "properties": {
              "$variable": {
                "type": "string",
                "description": "JSONPath expression including variable name"
              },
              "default": {
                "$ref": "#/components/schemas/ValueExpr"
              }
            },
            "additionalProperties": false
          },
          {
            "type": "object",
            "title": "LiteralExpr",
            "description": "Escaped literal: { $literal: any }",
            "required": [
              "$literal"
            ],
            "properties": {
              "$literal": {
                "allOf": []
              }
            },
            "additionalProperties": false
          },
          {
            "type": "object",
            "title": "If",
            "description": "Conditional: { $if: condition, then: expr, else?: expr }",
            "required": [
              "$if",
              "then"
            ],
            "properties": {
              "$if": {
                "$ref": "#/components/schemas/ValueExpr"
              },
              "then": {
                "$ref": "#/components/schemas/ValueExpr"
              },
              "else": {
                "$ref": "#/components/schemas/ValueExpr"
              }
            },
            "additionalProperties": false
          },
          {
            "type": "object",
            "title": "Coalesce",
            "description": "Coalesce: { $coalesce: [expr1, expr2, ...] }",
            "required": [
              "$coalesce"
            ],
            "properties": {
              "$coalesce": {
                "type": "array",
                "items": {
                  "$ref": "#/components/schemas/ValueExpr"
                }
              }
            },
            "additionalProperties": false
          },
          {
            "type": "array",
            "title": "ArrayExpr",
            "items": {
              "$ref": "#/components/schemas/ValueExpr"
            },
            "description": "Array of expressions"
          },
          {
            "type": "object",
            "title": "ObjectExpr",
            "description": "Object with expression values",
            "additionalProperties": {
              "$ref": "#/components/schemas/ValueExpr"
            }
          },
          {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "type": "boolean"
              },
              {
                "type": "number"
              },
              {
                "type": "string"
              }
            ],
            "title": "PrimitiveValue",
            "description": "Literal primitive value"
          }
        ],
        "description": "A value expression that can contain literal data or references to other values"
      },
      "WorkflowOverrides": {
        "type": "object",
        "description": "Workflow overrides that can be applied to modify step behavior at runtime.\n\nOverrides are keyed by step ID and contain merge patches or other transformation\nspecifications to modify step properties before execution.",
        "required": [
          "steps"
        ],
        "properties": {
          "steps": {
            "type": "object",
            "description": "Map of step ID to override specification",
            "additionalProperties": {
              "$ref": "#/components/schemas/StepOverride"
            },
            "propertyNames": {
              "type": "string"
            }
          }
        }
      }
    }
  },
  "tags": [
    {
      "name": "Blob",
      "description": "Blob API endpoints"
    },
    {
      "name": "Component",
      "description": "Component API endpoints"
    },
    {
      "name": "Flow",
      "description": "Flow API endpoints"
    },
    {
      "name": "Run",
      "description": "Run API endpoints"
    }
  ]
}