# Stepflow Python SDK Workspace
#
# Individual packages:
#   - stepflow-core/     - Core types and interfaces
#   - stepflow-api/      - Generated API client models
#   - stepflow-client/   - HTTP client for remote servers
#   - stepflow-runtime/  - Embedded runtime with bundled binary
#   - stepflow-server/   - Component server SDK

[tool.uv.workspace]
members = [
    "stepflow-core",
    "stepflow-api",
    "stepflow-client",
    "stepflow-runtime",
    "stepflow-server",
]

[tool.uv.sources]
stepflow-core = { workspace = true }
stepflow-api = { workspace = true }
stepflow-client = { workspace = true }
stepflow-runtime = { workspace = true }
stepflow-server = { workspace = true }

# =============================================================================
# Development tasks (run with: uv run poe <task>)
# =============================================================================

[dependency-groups]
dev = ["poethepoet>=0.24.0"]

[tool.poe]
verbosity = -1

[tool.poe.tasks.fmt]
help = "Format all code"
cmd = "uvx ruff@0.9.4 format ."

[tool.poe.tasks.lint]
help = "Lint and fix all code"
cmd = "uvx ruff@0.9.4 check --fix ."

[tool.poe.tasks.check]
help = "Check formatting and linting (no fixes)"
sequence = [
    { cmd = "uvx ruff@0.9.4 format --check ." },
    { cmd = "uvx ruff@0.9.4 check ." },
]

[tool.poe.tasks.test]
help = "Run all tests"
cmd = "uv run pytest"

[tool.poe.tasks.typecheck]
help = "Run type checking"
cmd = "uv run mypy stepflow-server/src"

[tool.poe.tasks.codegen]
help = "Regenerate protocol types from schemas"
cmd = "uv run python generate.py"

[tool.poe.tasks.api-gen]
help = "Regenerate API client from OpenAPI spec"
cmd = "python scripts/generate_api_client.py generate"

[tool.poe.tasks.api-check]
help = "Check if API client is up-to-date"
cmd = "python scripts/generate_api_client.py check"

[tool.poe.tasks.api-update]
help = "Update OpenAPI spec from server and regenerate"
cmd = "python scripts/generate_api_client.py update-spec --generate"

# =============================================================================
# Shared tool configuration
# =============================================================================

[tool.ruff]
target-version = "py311"
line-length = 88
extend-exclude = ["**/generated_*.py"]

[tool.ruff.lint]
select = ["E", "F", "I", "W", "UP", "B", "C4"]

[tool.ruff.lint.per-file-ignores]
"**/{tests,scripts}/*" = ["T201", "B018", "F841"]
"generate.py" = ["T201", "E501"]
"**/generated_*.py" = ["E501", "UP006", "UP035"]

[tool.ruff.format]
quote-style = "double"
indent-style = "space"
exclude = ["**/generated_*.py"]

[tool.mypy]
python_version = "3.11"
warn_return_any = true
warn_unused_configs = true
check_untyped_defs = true

[[tool.mypy.overrides]]
module = ["tests.*", "stepflow_server.generated_*"]
ignore_errors = true

[tool.pytest.ini_options]
asyncio_default_fixture_loop_scope = "function"
asyncio_mode = "auto"
