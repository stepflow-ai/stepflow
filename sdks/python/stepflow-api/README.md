# stepflow-api

Generated API client models for communicating with Stepflow servers.

> **Note:** This package contains auto-generated code. Do not edit generated files directly.
> See [Code Generation](#code-generation) for how to update.

## Installation

```bash
pip install stepflow-api
```

## Overview

This package provides:
- **Pydantic models** for all Stepflow API request/response types
- **HTTP client utilities** for making API calls
- **Type-safe interfaces** for workflow execution, batch operations, and component discovery

It is used internally by `stepflow-client` and `stepflow-runtime`. Most users should install those packages instead of using `stepflow-api` directly.

## Usage

```python
from stepflow_api import Client
from stepflow_api.models import CreateRunRequest, CreateRunResponse
from stepflow_api.api.run import create_run

client = Client(base_url="http://localhost:7837")

# Make API calls
response = await create_run.asyncio_detailed(
    client=client,
    body=CreateRunRequest(flow_id="...", input={...})
)
```

## Code Generation

This package is generated from the Stepflow server's OpenAPI specification (`../../schemas/openapi.json`).

> **Note:** The OpenAPI spec is not hand-written - it's generated by running the Stepflow server and fetching its `/api/v1/openapi.json` endpoint. Use `uv run poe api-gen --update-spec` to update it (requires Rust toolchain).

### File Structure

```
stepflow-api/
├── src/stepflow_api/
│   ├── models/
│   │   ├── generated.py      # Auto-generated Pydantic models (DO NOT EDIT)
│   │   ├── __init__.py       # Auto-generated exports + compatibility methods
│   │   ├── *.py              # Re-export stubs OR custom overrides
│   │   └── ...
│   ├── api/                  # Static API endpoint modules
│   ├── client.py             # Static HTTP client wrapper
│   ├── types.py              # Static utility types (UNSET, Response)
│   └── errors.py             # Static error types
└── ...
```

### Generated vs Static Files

**Auto-generated (regenerated by `api-gen`):**
- **`models/generated.py`**: Pydantic models from OpenAPI spec. Never edit.
- **`models/__init__.py`**: Exports + compatibility methods. Never edit.
- **`models/*.py` (stubs)**: Simple re-exports. Can be replaced with custom overrides.

**Static (maintained manually, not regenerated):**
- **`api/`**: Endpoint modules for API calls.
- **`client.py`**: HTTP client wrapper.
- **`types.py`**: Utility types (UNSET, Response).
- **`errors.py`**: Error types.

Custom model overrides (files that don't start with `"""Re-export`) are automatically preserved when regenerating.

### Regenerating Models

When the Rust API changes:

```bash
# Update spec from server AND regenerate (single command)
uv run poe api-update

# Then run tests to verify
uv run poe test
```

To just regenerate from the existing spec:

```bash
uv run poe api-gen
```

To check if models are up-to-date (used in CI):

```bash
uv run poe api-check
```

For more control, use the script directly:

```bash
python scripts/generate_api_client.py generate              # Regenerate from stored spec
python scripts/generate_api_client.py generate --from FILE  # Regenerate from specific file
python scripts/generate_api_client.py check                 # Check if up-to-date
python scripts/generate_api_client.py update-spec           # Only update spec (no regenerate)
python scripts/generate_api_client.py update-spec --generate  # Update AND regenerate
```

### Generation Tools

The generation script (`scripts/generate_api_client.py`) uses:
- **datamodel-code-generator**: Generates Pydantic v2 models from OpenAPI
- **ruff**: Formats generated code

### Custom Model Overrides (Known Issue)

Several models require custom overrides due to mismatches between the Rust server's serde representation and what the OpenAPI schema generator produces. These are preserved during regeneration.

#### Current Overrides

| File | Issue | Root Cause |
|------|-------|------------|
| `create_run_response.py` | FlowResult format | Serde tagging mismatch |
| `run_details.py` | FlowResult format | Serde tagging mismatch |
| `batch_output_info.py` | FlowResult format | Serde tagging mismatch |
| `list_batch_outputs_response.py` | Uses custom BatchOutputInfo | Depends on above |
| `create_run_request.py` | RootModel unwrapping | Pydantic RootModel behavior |
| `workflow_overrides.py` | Transparent serialization | `#[serde(transparent)]` |

#### Why These Exist

1. **FlowResult tagging mismatch** (4 files): The Rust server uses internally-tagged enums (`{"outcome": "success", "result": ...}`) via `#[serde(tag = "outcome")]`, but the OpenAPI generator produces externally-tagged unions (`{"Success": ...}`).

2. **RootModel handling** (1 file): `BlobId` and `ValueRef` are generated as Pydantic `RootModel` types, requiring special `.root` access for serialization.

3. **Transparent serialization** (1 file): Rust's `#[serde(transparent)]` on `WorkflowOverrides` means the server expects `{step_id: ...}` directly, not `{"steps": {step_id: ...}}`.

#### Path to Resolution

These overrides can be eliminated by fixing the source:

1. **FlowResult**: Change Rust to use externally-tagged enums, or fix the OpenAPI schema generator to represent internally-tagged enums correctly.

2. **WorkflowOverrides**: Remove `#[serde(transparent)]` from the Rust type definition.

3. **RootModel**: Configure datamodel-code-generator differently, or post-process generated code.

Until these are fixed upstream, the overrides are necessary and are automatically preserved during regeneration.

## License

Apache-2.0
